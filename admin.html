<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set shop - ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="admin-styles.css">
</head>

<body>
    <!-- Login Form directly on Admin Page -->
    <div id="admin-login-overlay" class="admin-login-overlay">
        <div class="admin-login-box">
            <h2>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
            <form id="admin-login-form">
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Admin)</label>
                    <input type="text" id="admin-username" required>
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="admin-password" required>
                </div>
                <div id="admin-error" class="error-msg">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</div>
                <button type="submit" class="admin-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                <a href="shop.html" style="color: #666; font-size: 13px; text-decoration: none;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-dashboard" style="display: none;">
        <header class="admin-header">
            <div class="logo">
                <h1>SET<span>SHOP</span> Admin Panel</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="shop.html" class="logout-btn"
                    style="text-decoration: none; display: flex; align-items: center; background-color: #3b61fa; border-color: #3b61fa;">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</a>
                <button id="logout-btn" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </header>

        <main class="admin-content">
            <div class="stats-cards">
                <div class="card">
                    <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <p id="total-users">0</p>
                </div>
                <div class="card" onclick="showTroubleshootSection()" style="cursor: pointer; border-color: #8da2fb;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                    <p id="total-troubleshoot">0</p>
                </div>
            </div>

            <nav class="admin-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="showSection('products')" class="tab-btn active" id="tab-products">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="showSection('users')" class="tab-btn" id="tab-users">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                <button onclick="showSection('troubleshoot')" class="tab-btn"
                    id="tab-troubleshoot">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>
            </nav>

            <section class="products-section"
                style="margin-bottom: 30px; background: linear-gradient(145deg, #232527, #1b1c1e); padding: 24px; border-radius: 12px; border: 1px solid #393b3d; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
                <div class="section-header" style="margin-bottom: 0;">
                    <div>
                        <h2 style="display: flex; align-items: center; gap: 8px;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#ff9900"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </h2>
                        <div style="font-size: 13px; color: #ff9900; margin-top: 6px;">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏∂‡πà‡∏á Database (‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
                        </div>
                    </div>
                    <button class="export-btn"
                        style="background: linear-gradient(90deg, #ff9900, #ffb84d); color: #111; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: transform 0.2s, box-shadow 0.2s; font-weight: 800; box-shadow: 0 4px 12px rgba(255,153,0,0.3);"
                        onmouseover="this.style.transform='translateY(-2px)';"
                        onmouseout="this.style.transform='translateY(0)';" onclick="addNewProduct()">+
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                </div>

                <div class="table-responsive" style="margin-top: 20px;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="troubleshoot-section" class="products-section"
                style="display: none; margin-bottom: 30px; background: linear-gradient(145deg, #1b1c1e, #141517); padding: 24px; border-radius: 12px; border: 1px solid #393b3d;">
                <div class="section-header">
                    <div>
                        <h2>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h2>
                        <div style="font-size: 13px; color: #8da2fb; margin-top: 6px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏≤‡∏Å‡∏é‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                            "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤"</div>
                    </div>
                    <button class="export-btn" style="background: #8da2fb; color: #111;"
                        onclick="addNewTroubleshoot()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div class="table-responsive" style="margin-top: 20px;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="troubleshoot-table-body">
                            <!-- Troubleshoot items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="users-section" class="users-section" style="display: none;">
                <div class="section-header">
                    <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="export-csv-btn" class="export-btn"
                            style="background-color: transparent; color: #4CAF50; border: 1px solid #4CAF50; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏ß‡∏£
                            (CSV)</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</th>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (S)</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Admin Alert Modal -->
    <div id="admin-alert-modal" class="admin-modal">
        <div class="admin-modal-content" style="text-align: center; align-items: center; max-width: 350px;">
            <div
                style="background-color: rgba(59,97,250,0.1); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <svg viewBox="0 0 24 24" width="30" height="30" fill="none" stroke="#3b61fa" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <h2 id="admin-alert-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
            <p id="admin-alert-text"></p>
            <button class="admin-btn" style="width: 100%; border-radius: 6px;" onclick="closeAdminAlert()">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <!-- Product Edit/Add Modal -->
    <div id="product-modal" class="admin-modal">
        <div class="admin-modal-content" style="max-width: 500px;">
            <h2 id="product-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="p-name" class="admin-modal-input" style="margin-bottom: 10px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="p-price" class="admin-modal-input" style="margin-bottom: 10px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                    <input type="number" id="p-stock" class="admin-modal-input" style="margin-bottom: 10px;">
                </div>
            </div>
            <div class="form-group">
                <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="p-image" class="admin-modal-input"
                        placeholder="https://example.com/image.png" style="margin-bottom: 0;">
                    <button class="admin-btn" style="width: auto; padding: 0 15px; background: #333;"
                        onclick="previewImage()">‡∏î‡∏π‡∏£‡∏π‡∏õ</button>
                </div>
                <div id="image-preview-container"
                    style="display: none; margin-top: 10px; text-align: center; background: #1a1b1e; border-radius: 12px; padding: 10px; border: 1px dashed #3d3d3d;">
                    <img id="p-image-preview" src="" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                    <div id="p-image-error" style="color: #ff4d4f; font-size: 11px; margin-top: 5px; display: none;">
                        ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>
                </div>
            </div>
            <div class="form-group">
                <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î / ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="p-link" class="admin-modal-input" style="margin-bottom: 10px;">
            </div>
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <textarea id="p-desc" class="admin-modal-input"
                    style="height: 100px; resize: vertical; margin-bottom: 10px;"></textarea>
            </div>
            <div class="admin-modal-actions">
                <button class="admin-btn"
                    style="background-color: #111214; border: 1px solid #3d3d3d; width: auto; color: #fff;"
                    onclick="closeProductModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="admin-btn" id="product-save-btn" style="width: auto;"
                    onclick="saveProduct()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
    <!-- Admin Prompt Modal -->
    <div id="admin-prompt-modal" class="admin-modal">
        <div class="admin-modal-content" id="admin-prompt-box">
            <h2 id="admin-prompt-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
            <p id="admin-prompt-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
            <input type="text" id="admin-prompt-input" class="admin-modal-input" placeholder="...">
            <div class="admin-modal-actions">
                <button class="admin-btn"
                    style="background-color: #111214; border: 1px solid #3d3d3d; width: auto; color: #fff;"
                    onclick="closeAdminPrompt()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="admin-btn" id="admin-prompt-submit-btn" style="width: auto;"
                    onclick="submitAdminPrompt()">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>


    <script>
        // Custom Modal Logic
        function showAdminAlert(title, text) {
            document.getElementById('admin-alert-title').innerHTML = title;
            document.getElementById('admin-alert-text').innerHTML = text;
            document.getElementById('admin-alert-modal').style.display = 'flex';
        }
        function closeAdminAlert() { document.getElementById('admin-alert-modal').style.display = 'none'; }

        function showAdminPrompt(title, text, placeholder, btnText, btnColor, themeColor, callback) {
            document.getElementById('admin-prompt-title').innerHTML = title;
            document.getElementById('admin-prompt-title').style.color = themeColor;
            document.getElementById('admin-prompt-box').style.borderTopColor = themeColor;

            document.getElementById('admin-prompt-text').innerHTML = text;
            document.getElementById('admin-prompt-input').value = "";
            document.getElementById('admin-prompt-input').placeholder = placeholder;

            const submitBtn = document.getElementById('admin-prompt-submit-btn');
            submitBtn.textContent = btnText;
            submitBtn.style.backgroundColor = btnColor;

            document.getElementById('admin-prompt-modal').style.display = 'flex';
            window.currentAdminPromptCallback = callback;
            setTimeout(() => document.getElementById('admin-prompt-input').focus(), 0);
        }
        function closeAdminPrompt() { document.getElementById('admin-prompt-modal').style.display = 'none'; }

        function submitAdminPrompt() {
            const val = document.getElementById('admin-prompt-input').value;
            closeAdminPrompt();
            if (window.currentAdminPromptCallback) window.currentAdminPromptCallback(val);
        }

        const API_BASE = "/api";

        // Authentication check
        const loginForm = document.getElementById('admin-login-form');
        const overlay = document.getElementById('admin-login-overlay');
        const dashboard = document.getElementById('admin-dashboard');
        const errorMsg = document.getElementById('admin-error');

        if (localStorage.getItem('isAdminLoggedIn') === 'true') {
            showDashboard();
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('admin-username').value;
            const pass = document.getElementById('admin-password').value;

            if (user === 'Nitisak22' && pass === 'kobkeropy22') {
                localStorage.setItem('isAdminLoggedIn', 'true');
                showDashboard();
            } else {
                errorMsg.style.display = 'block';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('isAdminLoggedIn');
            window.location.href = 'login.html';
        });

        // CSV Export Logic
        document.getElementById('export-csv-btn').onclick = async () => {
            try {
                const res = await fetch(`${API_BASE}/users`);
                const users = await res.json();

                if (!users || users.length === 0) {
                    showAdminAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
                    return;
                }

                // CSV Header
                let csv = '‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ,‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô,‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô\n';

                // CSV Rows
                users.forEach((u, i) => {
                    const balance = u.balance || 0;
                    const date = u.registerDate || '-';
                    csv += `${i + 1},${u.username},${u.password},${balance},${date}\n`;
                });

                // Create blob and download (with BOM for Excel Thai support)
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `users_list_${new Date().getTime()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (CSV) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (err) {
                console.error('Export error:', err);
                showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            }
        };

        function showDashboard() {
            overlay.style.display = 'none';
            dashboard.style.display = 'block';
            showSection('products');
            loadUsersData();
            loadProductsData();
            loadTroubleshootData();
        }

        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            if (sectionId === 'products') {
                document.querySelector('.products-section').style.display = 'block';
                document.getElementById('tab-products').classList.add('active');
            } else if (sectionId === 'users') {
                document.getElementById('users-section').style.display = 'block';
                document.getElementById('tab-users').classList.add('active');
            } else if (sectionId === 'troubleshoot') {
                document.getElementById('troubleshoot-section').style.display = 'block';
                document.getElementById('tab-troubleshoot').classList.add('active');
            }
        }

        async function loadTroubleshootData() {
            const tableBody = document.getElementById('troubleshoot-table-body');
            const totalTroubleshootElem = document.getElementById('total-troubleshoot');
            try {
                const res = await fetch(`${API_BASE}/troubleshoot`);
                const items = await res.json();
                totalTroubleshootElem.textContent = items.length;
                tableBody.innerHTML = '';
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.title}</td>
                        <td><span style="background: rgba(88,101,242,0.1); color: #8da2fb; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${item.category}</span></td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editTroubleshoot('${item.id}')" style="background-color: #3b61fa; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="deleteTroubleshoot('${item.id}', '${item.title}')" style="background-color: transparent; color: #ff4d4f; border: 1px solid #ff4d4f; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (err) { console.error(err); }
        }

        async function addNewTroubleshoot() {
            showAdminPrompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤:', '', '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', '#8da2fb', '#8da2fb', (title) => {
                if (!title) return;
                showAdminPrompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ:', '', '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', '#8da2fb', '#8da2fb', (desc) => {
                    showAdminPrompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå', '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (URL):', '#', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '#8da2fb', '#8da2fb', async (link) => {
                        try {
                            const res = await fetch(`${API_BASE}/troubleshoot`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title, desc, link: link || "#", category: "Troubleshooting" })
                            });
                            if ((await res.json()).success) {
                                loadTroubleshootData();
                                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                            }
                        } catch (err) { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                    });
                });
            });
        }

        async function deleteTroubleshoot(id, title) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${title}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            try {
                const res = await fetch(`${API_BASE}/troubleshoot/${id}`, { method: 'DELETE' });
                if ((await res.json()).success) {
                    loadTroubleshootData();
                    showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            } catch (err) { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
        }

        async function editTroubleshoot(id) {
            try {
                const res = await fetch(`${API_BASE}/troubleshoot`);
                const items = await res.json();
                const item = items.find(t => t.id === id);
                if (!item) return;

                showAdminPrompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:', item.title, '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', '#3b61fa', '#3b61fa', (newTitle) => {
                    const title = newTitle || item.title;
                    showAdminPrompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:', item.desc, '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', '#3b61fa', '#3b61fa', (newDesc) => {
                        const desc = newDesc || item.desc;
                        showAdminPrompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå', '‡∏•‡∏¥‡∏á‡∏Å‡πå (URL):', item.link, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '#3b61fa', '#3b61fa', async (newLink) => {
                            const link = newLink || item.link;
                            try {
                                const saveRes = await fetch(`${API_BASE}/troubleshoot/${id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ title, desc, link, category: item.category })
                                });
                                if ((await saveRes.json()).success) {
                                    loadTroubleshootData();
                                    showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                                }
                            } catch (err) { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                        });
                    });
                });
            } catch (err) { console.error(err); }
        }

        async function loadProductsData() {
            const tableBody = document.getElementById('products-table-body');
            try {
                const res = await fetch(`${API_BASE}/products`);
                const products = await res.json();
                tableBody.innerHTML = '';
                products.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.price}</td>
                <td style="color: #ff9900; font-weight: bold;">${p.stock}</td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="editProduct('${p.id}')" style="background-color: #3b61fa; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="addStockAdmin('${p.id}', '${p.name}')" style="background-color: #ff9900; color: #111; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                        <button onclick="confirmDeleteProduct('${p.id}', '${p.name}')" style="background-color: transparent; color: #ff4d4f; border: 1px solid #ff4d4f; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    </div>
                </td>
                `;
                    tableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('Load products error:', err);
            }
        }

        function addStockAdmin(id, name) {
            showAdminPrompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', `‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ <strong>"${name}"</strong>:`, "100", "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å", "#ff9900", "#ff9900", async function (val) {
                const amount = parseInt(val);
                if (isNaN(amount) || amount <= 0) {
                    showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/products/${id}/stock`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ amount })
                    });
                    const data = await res.json();
                    if (data.success) {
                        loadProductsData();
                        showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
                    }
                } catch (err) {
                    showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                }
            });
        }

        async function confirmDeleteProduct(id, name) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${name}" ‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            try {
                const res = await fetch(`${API_BASE}/products/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadProductsData();
                    showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            } catch (err) {
                showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
            }
        }

        async function loadUsersData() {
            const tableBody = document.getElementById('users-table-body');
            const totalUsersElem = document.getElementById('total-users');
            try {
                const res = await fetch(`${API_BASE}/users`);
                const usersArray = await res.json();
                totalUsersElem.textContent = usersArray.length;
                tableBody.innerHTML = '';

                if (usersArray.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="no-data">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>';
                    return;
                }

                usersArray.forEach((user, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${user.username}</td>
                <td><span class="password-field">${user.password}</span></td>
                <td style="color: #ff9900; font-weight: bold;">${user.balance || 0} S</td>
                <td>${user.registerDate || '-'}</td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="addMoney('${user.username}')" style="background-color: #3b61fa; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                        <button onclick="confirmDeleteUser('${user.username}')" style="background-color: transparent; color: #ff4d4f; border: 1px solid #ff4d4f; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                    </div>
                </td>
                `;
                    tableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('Load users error:', err);
            }
        }

        function addMoney(username) {
            showAdminPrompt('‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                `‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (S) ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ <strong>"${username}"</strong>:`,
                "0",
                "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô", "#3b61fa", "#3b61fa",
                async function (amount) {
                    const parsedAmount = parseInt(amount);
                    if (isNaN(parsedAmount) || parsedAmount < 0) {
                        showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
                        return;
                    }
                    try {
                        const res = await fetch(`${API_BASE}/users/${username}/balance`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ amount: parsedAmount })
                        });
                        const data = await res.json();
                        if (data.success) {
                            loadUsersData();
                            showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${parsedAmount} S ‡πÉ‡∏´‡πâ "${username}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
                        }
                    } catch (err) {
                        showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                    }
                }
            );
        }

        function confirmDeleteUser(username) {
            showAdminPrompt('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ñ‡∏≤‡∏ß‡∏£ ‚ö†Ô∏è',
                `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö "${username}" ‡∏ñ‡∏≤‡∏ß‡∏£? ‡∏û‡∏¥‡∏°‡∏û‡πå "CONFIRM"`,
                "",
                "‡∏•‡∏ö‡πÄ‡∏•‡∏¢", "#ff4d4f", "#ff4d4f",
                async function (val) {
                    if (val === "CONFIRM") {
                        try {
                            const res = await fetch(`${API_BASE}/users/${username}`, { method: 'DELETE' });
                            const data = await res.json();
                            if (data.success) {
                                loadUsersData();
                                showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                            }
                        } catch (err) {
                            showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                        }
                    }
                }
            );
        }

        let editingProductId = null;

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        function addNewProduct() {
            editingProductId = null;
            document.getElementById('product-modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('p-name').value = '';
            document.getElementById('p-image').value = '';
            document.getElementById('p-link').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('product-modal').style.display = 'flex';
        }

        function previewImage() {
            const url = document.getElementById('p-image').value;
            const container = document.getElementById('image-preview-container');
            const img = document.getElementById('p-image-preview');
            const error = document.getElementById('p-image-error');

            if (!url) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            error.style.display = 'none';
            img.src = url;
            img.style.display = 'inline-block';

            img.onerror = () => {
                img.style.display = 'none';
                error.style.display = 'block';
            };
        }

        async function editProduct(id) {
            try {
                const res = await fetch(`${API_BASE}/products`);
                const products = await res.json();
                const p = products.find(prod => prod.id === id);
                if (p) {
                    editingProductId = id;
                    document.getElementById('product-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                    document.getElementById('p-name').value = p.name || '';
                    document.getElementById('p-price').value = p.price || '';
                    document.getElementById('p-stock').value = p.stock || '';
                    document.getElementById('p-image').value = p.imageUrl || '';
                    document.getElementById('p-link').value = p.downloadLink || '';
                    document.getElementById('p-desc').value = p.desc || '';

                    if (p.imageUrl) previewImage();
                    else document.getElementById('image-preview-container').style.display = 'none';

                    document.getElementById('product-modal').style.display = 'flex';
                }
            } catch (err) {
                showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
            }
        }

        async function saveProduct() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const stock = document.getElementById('p-stock').value;
            const imageUrl = document.getElementById('p-image').value;
            const downloadLink = document.getElementById('p-link').value;
            const desc = document.getElementById('p-desc').value;

            if (!name || !price) {
                showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                return;
            }

            const payload = {
                name,
                price: parseInt(price),
                stock: parseInt(stock) || 0,
                imageUrl,
                downloadLink,
                desc: desc || name,
                type: "Normal" // Default type
            };

            try {
                const url = editingProductId ? `${API_BASE}/products/${editingProductId}` : `${API_BASE}/products`;
                const method = editingProductId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                let data;
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await res.json();
                } else {
                    const text = await res.text();
                    throw new Error(text || `Server error: ${res.status}`);
                }

                if (data.success) {
                    closeProductModal();
                    loadProductsData();
                    showAdminAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', editingProductId ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (err) {
                console.error('Save error:', err);
                showAdminAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message);
            }
        }
    </script>
</body>

</html>


