<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set shop - ร้านค้า</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shop-styles.css">
    <style>
        /* ย้ายสไตล์หิมะมาไว้ในนี้โดยตรง เพื่อป้องกันไฟล์ตีกัน */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .snowflake { position: absolute; top: -10px; color: #fff; user-select: none; z-index: 9999; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)); animation: fall linear infinite, sway ease-in-out infinite; }
        @keyframes fall { 0% { top: -10%; } 100% { top: 110%; } }
        @keyframes sway { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(50px); } }
    </style>
</head>

<body>
    <!-- ระบบนำทาง -->
    <nav class="shop-nav">
        <div class="nav-container">
            <div class="logo">SET<span>SHOP</span></div>
            <div class="nav-right">
                <span id="user-display" class="user-greeting">ผู้ใช้: กำลังโหลด...</span>
                <span id="user-balance" class="user-greeting" style="color: #4CAF50; font-weight: 700; background: rgba(76,175,80,0.1); padding: 4px 10px; border-radius: 4px;">ยอดเงิน: 0 S</span>
                <button id="logout-btn" class="nav-btn logout-btn">ออกจากระบบ</button>
            </div>
        </div>
    </nav>

    <main class="shop-container">
        <div class="section-header">
            <div class="title-area">
                <h2 class="main-title"><span class="dot"></span> รายการสินค้า</h2>
                <p class="sub-title">Product Recommended</p>
            </div>
        </div>

        <div class="products-grid" id="products-grid">
            <div style="color: #888; text-align: center; grid-column: 1/-1; padding: 50px;">กำลังโหลดสินค้า...</div>
        </div>
    </main>

    <script>
        const API_BASE = "/api";
        const activeUser = localStorage.getItem('lastLoggedInUser');

        if (!activeUser) window.location.href = 'login.html';
        else document.getElementById('user-display').textContent = `ผู้ใช้: ${activeUser}`;

        async function init() {
            try {
                // ดึงข้อมูลยอดเงิน
                const uRes = await fetch(`${API_BASE}/users`);
                const users = await uRes.json();
                const user = users.find(u => u.username === activeUser);
                if (user) document.getElementById('user-balance').textContent = `ยอดเงิน: ${user.balance || 0} S`;

                // ดึงรายการสินค้า
                const pRes = await fetch(`${API_BASE}/products`);
                const products = await pRes.json();
                const grid = document.getElementById('products-grid');
                grid.innerHTML = '';

                products.forEach(p => {
                    grid.innerHTML += `
                        <div class="product-card">
                            <div class="product-image">
                                <div class="img-placeholder">${p.imgText || p.name.substring(0,2)}</div>
                            </div>
                            <div class="product-info">
                                <h3 class="product-name">${p.name}</h3>
                                <div class="stock">เหลือ ${p.stock} ชิ้น</div>
                                <div class="price-row">
                                    <div class="price">${p.price} ฿</div>
                                    <button class="buy-btn" onclick="buy('${p.id}', '${p.name}', ${p.price})">ซื้อเลย</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error(err); }
        }

        window.buy = async (id, name, price) => {
            if (!confirm(`ยืนยันการซื้อ ${name} ราคา ${price} ฿?`)) return;
            const res = await fetch(`${API_BASE}/buy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: activeUser, productId: id })
            });
            const data = await res.json();
            if (data.success) { alert('สำเร็จ!'); init(); }
            else alert(data.message);
        };

        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('lastLoggedInUser');
            window.location.href = 'login.html';
        };

        init();
    </script>
    <script src="snow.js"></script>
</body>
</html>
